name: Publish NuGet Package (Legacy API Key)

on:
	push:
		tags:
			- 'v*'  # Trigger on version tags like v1.0.0, v0.3.0-beta
	release:
		types: [published]
	workflow_dispatch:  # Allow manual trigger

jobs:
	publish:
		runs-on: ubuntu-latest

		# Legacy flow uses repository secret NUGET_USER (not recommended).
		permissions:
			contents: read

		steps:
			- name: Checkout repository
				uses: actions/checkout@v4

			- name: Setup .NET
				uses: actions/setup-dotnet@v4
				with:
					dotnet-version: '8.0.x'

			- name: Restore dependencies
				run: dotnet restore ContosoMCP/ContosoMCP.csproj

			- name: Build
				run: dotnet build ContosoMCP/ContosoMCP.csproj --configuration Release --no-restore

			- name: Run tests
				run: dotnet test --configuration Release --no-build --verbosity normal

			- name: Pack NuGet package
				run: dotnet pack ContosoMCP/ContosoMCP.csproj --configuration Release --no-build --output ./nupkg

			- name: List generated packages
				run: ls -la ./nupkg/

			- name: Validate NuGet secret
				if: ${{ secrets.NUGET_USER == '' }}
				run: |
					echo "NUGET_USER secret is not configured. Add it in Repository Settings > Secrets and variables > Actions." \
					&& exit 1

			- name: Publish to NuGet.org (Legacy Secret)
				env:
					NUGET_USER: ${{ secrets.NUGET_USER }}
				run: |
					dotnet nuget push ./nupkg/*.nupkg \
						--api-key "$NUGET_USER" \
						--source https://api.nuget.org/v3/index.json \
						--skip-duplicate
